<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/head :: html_head">
    <title>Leave Application</title>
</head>
<body>
<div th:replace="fragments/navbar :: menu"></div>

<div class="container w-75 mt-5 text-center">
    <h3 class="mb-3 mt-3 text-center">Leave Application Details</h3>

    <script>
        //Ensure either Approve or Reject selected
        function validateForm() {
            const leaveStatusChecked = document.querySelector('input[name="leaveStatus"]:checked');
            if (!leaveStatusChecked) {
                alert("Please select either Approve or Reject.");
                return false;
            }
            const leaveStatus = leaveStatusChecked.value;
            const rejectionReason = document.getElementById('rejectionReason').value;

            //Ensure rejection reason given
            if (leaveStatus === 'REJECTED' && rejectionReason.trim() === '') {
                alert("Please provide a reason for rejection.");
                return false;
            }
            return true;
        }

        // Check for the success parameter in the URL
        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('updateSuccess') === 'true') {
                alert("Leave status has been updated successfully.");
            }
        };
    </script>

    <form th:object="${leave}" method="post" th:action="@{/manager/leave/submitLeaveApplication}" onsubmit="return validateForm();">
        <input type="hidden" th:field="${leave.id}"/>
        <input type="hidden" th:field="${leave.submittingEmployee}"/>
        <input type="hidden" th:field="${leave.reviewingManager}"/>
        <input type="hidden" th:field="${leave.leaveType}"/>
        <input type="hidden" th:field="${leave.startDate}"/>
        <input type="hidden" th:field="${leave.endDate}"/>
        <input type="hidden" th:field="${leave.submissionReason}"/>
        <input type="hidden" th:field="${leave.workDissemination}"/>
        <input type="hidden" th:field="${leave.contactDetails}"/>

        <div class="row mb-3">
            <label class="col-4 col-form-label">Employee Name</label>
            <div class="col-8">
                <p class="form-control-plaintext" th:text="${leave.submittingEmployee.name}"></p>
            </div>
        </div>
        <div class="row mb-3">
            <label class="col-4 col-form-label">Leave Type</label>
            <div class="col-8">
                <p class="form-control-plaintext" th:text="${leave.leaveType}"></p>
            </div>
        </div>
        <div class="row mb-3">
            <label class="col-4 col-form-label">Start Date</label>
            <div class="col-8">
                <p class="form-control-plaintext" th:text="${#temporals.format(leave.startDate, 'dd-MMM-yyyy')}"></p>
            </div>
        </div>
        <div class="row mb-3">
            <label class="col-4 col-form-label">End Date</label>
            <div class="col-8">
                <p class="form-control-plaintext" th:text="${#temporals.format(leave.endDate, 'dd-MMM-yyyy')}"></p>
            </div>
        </div>
        <div class="row mb-3">
            <label class="col-4 col-form-label">Approving Manager</label>
            <div class="col-8">
                <p class="form-control-plaintext" th:text="${leave.submittingEmployee.manager.name}"></p>
            </div>
        </div>
        <div class="row mb-3">
            <label class="col-4 col-form-label">Reason</label>
            <div class="col-8">
                <p class="form-control-plaintext" th:text="${leave.submissionReason}"></p>
            </div>
        </div>
        <div class="row mb-3">
            <label class="col-4 col-form-label">Work Dissemination (if any)</label>
            <div class="col-8">
                <p class="form-control-plaintext" th:text="${leave.workDissemination}"></p>
            </div>
        </div>
        <div class="row mb-3">
            <label class="col-4 col-form-label">Contact Details (if on an overseas trip)</label>
            <div class="col-8">
                <p class="form-control-plaintext" th:text="${leave.contactDetails}"></p>
            </div>
        </div>
        <div class="row mb-3">
            <label class="col-4 col-form-label">Leave Status</label>
            <div class="col-8">
                <p class="form-control-plaintext" th:text="${leave.leaveStatus}"></p>
            </div>
        </div>
        <div class="row mb-3">
            <label class="col-4 col-form-label">Approval Status</label>
            <div class="col-8">
                <fieldset>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" id="approve" name="leaveStatus" value="APPROVED" th:field="*{leaveStatus}" />
                        <label class="form-check-label" for="approve">Approve</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" id="reject" name="leaveStatus" value="REJECTED" th:field="*{leaveStatus}" />
                        <label class="form-check-label" for="reject">Reject</label>
                    </div>
                </fieldset>
                <div th:if="${#fields.hasErrors('leaveStatus')}" th:errors="*{leaveStatus}" class="text-danger"></div>
            </div>
        </div>
        <div class="row mb-3">
            <label class="col-4 col-form-label" for="rejectionReason">Rejection Reason</label>
            <div class="col-8">
                <textarea class="form-control" id="rejectionReason" rows="2" cols="50" th:field="*{rejectionReason}"></textarea>
                <div th:if="${#fields.hasErrors('rejectionReason')}" th:errors="*{rejectionReason}" class="text-danger"></div>
            </div>
        </div>
        <div class="row mb-3">
            <div class="col-8 offset-4">
                <button type="submit" class="btn btn-primary">Confirm</button>
            </div>
        </div>
        <div class="row mb-3">
            <div class="col-8 offset-4">
                <a class="btn btn-secondary" href="#" onclick="window.location.href='/manager/leave/pendingLeaves'; return false;">Back</a>
            </div>
        </div>
    </form>
</div>

</body>
</html>
